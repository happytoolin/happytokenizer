---
import { ModelTokenizerWithStats } from "../../components/react/ModelTokenizerWithStats";
import { LeapOCRPromotion } from "../../components/react/LeapOCRPromotion";
import Navbar from "../../components/Navbar.astro";
import MainLayout from "../../layouts/MainLayout.astro";
import { getEncodingForModel } from "../../utils/modelEncodings";
import { getPricing, MODELS } from "../../utils/models";

export async function getStaticPaths() {
  const paths = Object.entries(MODELS).map(([modelId, modelData]) => ({
    params: { model: modelId },
    props: {
      model: modelData,
      modelId: modelId,
    },
  }));
  return paths;
}

const { model, modelId } = Astro.props;

// Generate SEO metadata
const pageTitle = `${model.displayName} // HappyTokenizer`;
const pageDescription = `Structural tokenization analysis for ${model.displayName}. Real-time ${model.encoding} visualization, context window physics, and cost computations.`;
const canonicalUrl = `https://happytokenizer.com/models/${modelId}`;

const pricing = getPricing(modelId);
const encodingType = getEncodingForModel(modelId);

const structuredData = {
  "@context": "https://schema.org",
  "@type": "SoftwareApplication",
  name: `${model.displayName} Tokenizer`,
  description: pageDescription,
  url: canonicalUrl,
  applicationCategory: "DeveloperApplication",
  operatingSystem: "Any",
  offers: {
    "@type": "Offer",
    price: `${pricing.input * 1000}`,
    priceCurrency: "USD",
    description: "Input tokens per 1K tokens",
  },
};
---

<MainLayout title={pageTitle} description={pageDescription}>
  <style
    define:vars={{
      "c-orange": "#ff6600",
      "c-black": "#1a1a1a",
      "c-paper": "#f2f2f0",
    }}
  >
    .happytokenizer-grid {
      background-image:
        linear-gradient(var(--c-black) 1px, transparent 1px),
        linear-gradient(90deg, var(--c-black) 1px, transparent 1px);
      background-size: 40px 40px;
      background-position: -1px -1px;
      mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
    }

    /* Sticker/Badge Effect */
    .badge-rotate {
      transform: rotate(-2deg);
      transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    .badge-rotate:hover {
      transform: rotate(0deg) scale(1.05);
    }
  </style>

  <script
    type="application/ld+json"
    set:html={JSON.stringify(structuredData)}
  />

  <div class="min-h-screen w-full relative overflow-hidden bg-[var(--c-paper)]">
    <!-- Background Grid -->
    <div
      class="absolute inset-0 opacity-[0.03] happytokenizer-grid pointer-events-none z-0"
    >
    </div>

    <div
      class="relative z-10 max-w-[1400px] mx-auto p-4 md:p-8 lg:p-12 flex flex-col gap-12"
    >
      <!-- HEADER SECTION -->
      <header class="flex flex-col gap-6">
        <Navbar currentPage="model-detail" modelId={modelId} />

        <!-- Title Block -->
        <div class="relative group">
          <h1
            class="font-display text-6xl md:text-8xl lg:text-9xl font-black uppercase leading-[0.85] tracking-tighter text-[var(--c-black)] mix-blend-multiply mb-4"
          >
            {model.displayName}
          </h1>
          <div
            class="absolute top-0 right-0 md:right-20 transform -translate-y-1/2 rotate-12 bg-[var(--c-orange)] text-white font-mono text-xs font-bold px-4 py-2 border border-black shadow-[4px_4px_0px_#000] badge-rotate cursor-help z-20"
          >
            {encodingType}
          </div>
        </div>

        <!-- Description & Tags -->
        <div class="grid grid-cols-1 lg:grid-cols-[1fr_300px] gap-8 items-end">
          <p
            class="font-body text-lg md:text-xl leading-relaxed text-gray-800 max-w-2xl border-l-4 border-[var(--c-orange)] pl-6"
          >
            Structural tokenization analysis engine. Optimized for <strong
              class="bg-[var(--c-orange)]/20 px-1">{model.displayName}</strong
            > inputs. Calibrate context windows and compute precise API economics
            in real-time.
          </p>

          <!-- Quick Stats Mini-Grid -->
          <div class="grid grid-cols-2 gap-px bg-black border border-black">
            <div class="bg-white p-3 hover:bg-[var(--c-paper)] transition-colors">
              <div class="font-mono text-[10px] uppercase text-gray-500 mb-1">
                Context
              </div>
              <div class="font-display text-xl font-bold">
                {
                  model.contextWindow >= 100000
                    ? `${model.contextWindow / 1000}k`
                    : model.contextWindow
                }
              </div>
            </div>
            <div class="bg-white p-3 hover:bg-[var(--c-paper)] transition-colors">
              <div class="font-mono text-[10px] uppercase text-gray-500 mb-1">
                Type
              </div>
              <div class="font-display text-xl font-bold">LLM</div>
            </div>
          </div>
        </div>
      </header>

      <!-- MAIN WORKSPACE -->
      <main class="grid grid-cols-1 lg:grid-cols-[1fr_360px] gap-8">
        <!-- LEFT COL: Tokenizer -->
        <div class="flex flex-col gap-4">
          <div class="flex items-center justify-between">
            <h2
              class="font-mono text-sm font-bold uppercase tracking-widest flex items-center gap-2"
            >
              <span class="w-2 h-2 rounded-full bg-[var(--c-orange)] animate-pulse"
              ></span>
              Live Input Stream
            </h2>
            <div class="hidden md:flex gap-2">
              <span
                class="font-mono text-[10px] border border-black px-2 py-0.5 bg-white"
                >SECURE</span
              >
              <span
                class="font-mono text-[10px] border border-black px-2 py-0.5 bg-white"
                >CLIENT-SIDE</span
              >
            </div>
          </div>

          <div id="tokenizer-root" class="relative z-20">
            <ModelTokenizerWithStats client:idle selectedModel={modelId} />
          </div>
        </div>

        <!-- RIGHT COL: Specs & Data -->
        <div class="flex flex-col gap-8">
          <!-- Pricing Manifest -->
          <div
            class="bg-white border-2 border-black shadow-[8px_8px_0px_var(--c-black)] p-6 relative overflow-hidden group"
          >
            <div
              class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-[var(--c-orange)] to-[var(--c-black)]"
            >
            </div>

            <h3
              class="font-display text-2xl font-bold uppercase mb-6 flex items-center gap-2"
            >
              Cost Manifest
              <svg
                class="w-5 h-5 text-[var(--c-orange)]"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                ><path
                  stroke-linecap="square"
                  stroke-linejoin="miter"
                  stroke-width="2"
                  d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                ></path></svg
              >
            </h3>

            <div class="space-y-4 font-mono text-xs">
              <!-- Input -->
              <div
                class="flex justify-between items-end border-b border-dashed border-gray-300 pb-2"
              >
                <span class="text-gray-500 uppercase">Input / 1M</span>
                <span class="text-base font-bold bg-[#F0F0F0] px-1"
                  >${(pricing.input * 1000).toFixed(2)}</span
                >
              </div>

              <!-- Output -->
              <div
                class="flex justify-between items-end border-b border-dashed border-gray-300 pb-2"
              >
                <span class="text-gray-500 uppercase">Output / 1M</span>
                <span class="text-base font-bold bg-[#F0F0F0] px-1"
                  >${(pricing.output * 1000).toFixed(2)}</span
                >
              </div>

              <!-- Cached -->
              <div class="flex justify-between items-end pb-2">
                <span class="text-[var(--c-orange)] uppercase font-bold"
                  >Cached Write</span
                >
                <span
                  class="text-base font-bold text-[var(--c-orange)] bg-[var(--c-orange)]/10 px-1"
                  >${(pricing.cached * 1000).toFixed(2)}</span
                >
              </div>
            </div>

            <div class="mt-6 pt-4 border-t-2 border-black">
              <p class="font-sans text-[10px] leading-tight text-gray-500">
                * Rates are estimated based on OpenAI standard tier. Actual
                billing may vary based on batch processing and enterprise
                agreements.
              </p>
            </div>
          </div>

          <!-- Technical Specs -->
          <div class="border border-black bg-[var(--c-black)] text-white p-6">
            <h3
              class="font-mono text-xs font-bold uppercase tracking-widest text-[var(--c-orange)] mb-4"
            >
              // Technical Specifications
            </h3>
            <dl class="grid grid-cols-1 gap-4 font-mono text-xs">
              <div class="flex flex-col gap-1">
                <dt class="text-gray-500">ARCHITECTURE ID</dt>
                <dd class="text-white border-b border-gray-800 pb-2">
                  {modelId}
                </dd>
              </div>
              <div class="flex flex-col gap-1">
                <dt class="text-gray-500">TOKEN ENCODING</dt>
                <dd class="text-white border-b border-gray-800 pb-2">
                  {encodingType}
                </dd>
              </div>
              <div class="flex flex-col gap-1">
                <dt class="text-gray-500">MAX CONTEXT</dt>
                <dd class="text-white pb-2 flex items-center gap-2">
                  {model.contextWindow.toLocaleString()}
                  <span class="text-[10px] text-gray-500">TOKENS</span>
                </dd>
              </div>
            </dl>
          </div>
        </div>
      </main>

      <!-- LEAP OCR PROMOTION BANNER -->
      <div class="px-4 md:px-8 lg:px-12">
        <LeapOCRPromotion layout="horizontal" className="w-full" />
      </div>

      <!-- RELATED MODELS FOOTER -->
      <footer class="border-t-2 border-black pt-12 pb-24">
        <h3 class="font-display text-3xl font-bold uppercase mb-8">
          Related Architectures <span class="text-[var(--c-orange)]"
            >({encodingType})</span
          >
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
          {
            Object.entries(MODELS)
              .filter(
                ([_, m]) => m.encoding === encodingType && m.id !== modelId
              )
              .slice(0, 5)
              .map(([id, m]) => (
                <a
                  href={`/models/${id}`}
                  class="group block bg-white border border-gray-300 p-4 hover:border-black hover:bg-[var(--c-orange)] hover:text-white transition-all duration-200"
                >
                  <div class="font-mono text-[10px] text-gray-400 group-hover:text-white/70 mb-2">
                    {m.id}
                  </div>
                  <div class="font-display text-lg font-bold leading-none">
                    {m.displayName}
                  </div>
                </a>
              ))
          }
        </div>
      </footer>
    </div>
  </div>
</MainLayout>
